# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json

services:
  haproxy-l4:
    # ðŸ”¹ðŸ”¹ HAProxy L4 Ingress ðŸ”¹ðŸ”¹
    # This runs in host network mode so it can bind arbitrary TCP ports based on the generated config.
    #
    # IMPORTANT:
    # - Do NOT start this until you have removed conflicting host port bindings from stateful services
    #   (example: redis currently binds :6379 on the host in docker-compose.yml).
    # - Config is generated by scripts/osvc_l4_sync.sh into ${CONFIG_PATH}/haproxy/haproxy.cfg
    profiles:
      - ha-ingress
    image: docker.io/haproxy:2.9-alpine
    container_name: haproxy-l4
    network_mode: host
    volumes:
      - ${CONFIG_PATH:-./volumes}/haproxy:/usr/local/etc/haproxy:ro
    healthcheck:
      test: ["CMD-SHELL", "haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: always


