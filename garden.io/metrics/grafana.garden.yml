kind: Deploy
apiVersion: garden.io/v2
name: grafana
description: Grafana visualization and analytics platform
type: container
dependencies:
  - deploy.prometheus
  - deploy.victoriametrics

spec:
  image: docker.io/grafana/grafana:latest
  user: ${var.PUID || "1001"}:${var.PGID || "999"}
  env:
    GF_INSTALL_PLUGINS: grafana-piechart-panel,grafana-worldmap-panel,natel-discrete-panel,flant-statusmap-panel,vonage-status-panel,michaeldmoore-multistat-panel,grafana-polystat-panel,marcusolsson-dynamictext-panel,yesoreyeram-boomtable-panel,redis-datasource,grafana-clock-panel,grafana-simple-json-datasource,btplc-status-dot-panel,camptocamp-prometheus-alertmanager-datasource
    GF_LOG_LEVEL: ${var.GF_LOG_LEVEL || "info"}
    GF_PATHS_PROVISIONING: ${var.GF_PATHS_PROVISIONING || "/etc/grafana/provisioning"}
    GF_SECURITY_ADMIN_USER: ${var.GF_SECURITY_ADMIN_USER || "admin"}
    GF_SECURITY_ADMIN_PASSWORD: ${var.GF_SECURITY_ADMIN_PASSWORD}
    GF_SERVER_DOMAIN: ${var.GF_FQDN || "grafana.${var.domain}"}
    GF_SERVER_ROOT_URL: ${var.GF_URL || "https://grafana.${var.domain}"}
    GF_SERVER_SERVE_FROM_SUB_PATH: ${var.GF_SERVE_FROM_SUB_PATH || "false"}
    GF_FEATURE_TOGGLES_ENABLE: ${var.GF_FEATURE_TOGGLES_ENABLE || ""}
    GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS: ${var.GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS || "victoriametrics-datasource"}
    GF_SECURITY_COOKIE_SECURE: ${var.GF_SECURITY_COOKIE_SECURE || "true"}
    GF_SECURITY_COOKIE_SAMESITE: ${var.GF_SECURITY_COOKIE_SAMESITE || "lax"}
    GF_SECURITY_CONTENT_TYPE_PROTECTION: ${var.GF_SECURITY_CONTENT_TYPE_PROTECTION || "true"}
    GF_SECURITY_X_CONTENT_TYPE_OPTIONS: ${var.GF_SECURITY_X_CONTENT_TYPE_OPTIONS || "nosniff"}
    GF_SECURITY_X_XSS_PROTECTION: ${var.GF_SECURITY_X_XSS_PROTECTION || "true"}
    GF_SECURITY_STRICT_TRANSPORT_SECURITY: ${var.GF_SECURITY_STRICT_TRANSPORT_SECURITY || "true"}
    GF_USERS_ALLOW_SIGN_UP: ${var.GF_USERS_ALLOW_SIGN_UP || "false"}
    GF_USERS_ALLOW_ORG_CREATE: ${var.GF_USERS_ALLOW_ORG_CREATE || "false"}
    GF_USERS_AUTO_ASSIGN_ORG: ${var.GF_USERS_AUTO_ASSIGN_ORG || "true"}
    GF_USERS_AUTO_ASSIGN_ORG_ROLE: ${var.GF_USERS_AUTO_ASSIGN_ORG_ROLE || "Viewer"}
    GF_DATABASE_MAX_IDLE_CONN: ${var.GF_DATABASE_MAX_IDLE_CONN || "2"}
    GF_DATABASE_MAX_OPEN_CONN: ${var.GF_DATABASE_MAX_OPEN_CONN || "0"}
    GF_DATABASE_CONN_MAX_LIFETIME: ${var.GF_DATABASE_CONN_MAX_LIFETIME || "14400"}
    GF_SMTP_ENABLED: ${var.GF_SMTP_ENABLED || "false"}
    GF_SMTP_HOST: ${var.GF_SMTP_HOST || "localhost:587"}
    GF_SMTP_USER: ${var.GF_SMTP_USER || ""}
    GF_SMTP_PASSWORD: ${var.GF_SMTP_PASSWORD || ""}
    GF_SMTP_FROM_ADDRESS: ${var.GF_SMTP_FROM_ADDRESS || "contact@bolabaden.org"}
    GF_SMTP_FROM_NAME: ${var.GF_SMTP_FROM_NAME || "Grafana"}
  ports:
    - name: http
      containerPort: 3000
  volumes:
    - name: data
      containerPath: /var/lib/grafana
      sourcePath: ${var.config-path}/grafana/data
    - name: config
      containerPath: /etc/grafana/grafana.ini
      sourcePath: ${var.config-path}/grafana/grafana.ini
    - name: datasources
      containerPath: /etc/grafana/provisioning/datasources
      sourcePath: ${var.config-path}/grafana/provisioning/datasources
    - name: dashboards-config
      containerPath: /etc/grafana/provisioning/dashboards
      sourcePath: ${var.config-path}/grafana/provisioning/dashboards
    - name: dashboards
      containerPath: /var/lib/grafana/dashboards
      sourcePath: ${var.config-path}/grafana/dashboards
    - name: alerting
      containerPath: /etc/grafana/provisioning/alerting
      sourcePath: ${var.config-path}/grafana/provisioning/alerting
    - name: notifiers
      containerPath: /etc/grafana/provisioning/notifiers
      sourcePath: ${var.config-path}/grafana/provisioning/notifiers
    - name: plugins
      containerPath: /etc/grafana/provisioning/plugins
      sourcePath: ${var.config-path}/grafana/provisioning/plugins
  ingresses:
    - path: /
      port: http
      hostname: grafana.${var.domain}
  healthCheck:
    httpGet:
      path: /api/health
      port: http
  restartPolicy: always
