[DEFAULT]
nodes = micklethefickle beatapostapita cloudserver1 cloudserver2 cloudserver3
orchestrate = ha
topology = failover

[container#1]
type = docker
image = docker.io/rabbitmq:3-management
name = rabbitmq
hostname = rabbitmq
run_args = --network {env.STACK_NAME}_backend --add-host "host.docker.internal:host-gateway" -e RABBITMQ_DEFAULT_USER="{env.RABBITMQ_USERNAME}" -e RABBITMQ_DEFAULT_PASS="{env.RABBITMQ_PASSWORD}" -l "deunhealth.restart.on.unhealthy=true" -l "kuma.rabbitmq.http.name=rabbitmq.{env.TS_HOSTNAME}.{env.DOMAIN}" -l "kuma.rabbitmq.http.url=https://rabbitmq.{env.DOMAIN}" -l "kuma.rabbitmq.http.interval=60" --restart always
command = /bin/bash /rabbitmq-init.sh
volume_mounts = cfg#rabbitmq-init:/rabbitmq-init.sh:ro

[cfg#rabbitmq-init]
content = #!/bin/bash
    set -e
    rabbitmq-server -detached
    TIMEOUT=60
    ELAPSED=0
    until rabbitmqctl status > /dev/null 2>&1; do
      if [ $ELAPSED -ge $TIMEOUT ]; then
        echo "Timeout waiting for RabbitMQ to start"
        exit 1
      fi
      echo "Waiting for RabbitMQ to start..."
      sleep 2
      ELAPSED=$((ELAPSED + 2))
    done
    RABBITMQ_USER="${RABBITMQ_DEFAULT_USER:-rabbitmq}"
    RABBITMQ_PASS="${RABBITMQ_DEFAULT_PASS:-rabbitmq}"
    if ! rabbitmqctl list_users 2>/dev/null | grep -q "^${RABBITMQ_USER}[[:space:]]"; then
      echo "Creating RabbitMQ user: ${RABBITMQ_USER}"
      rabbitmqctl add_user "${RABBITMQ_USER}" "${RABBITMQ_PASS}" 2>/dev/null
      rabbitmqctl set_permissions -p / "${RABBITMQ_USER}" ".*" ".*" ".*" 2>/dev/null
      rabbitmqctl set_user_tags "${RABBITMQ_USER}" administrator 2>/dev/null
      echo "User ${RABBITMQ_USER} created successfully"
    else
      echo "User ${RABBITMQ_USER} already exists"
      rabbitmqctl change_password "${RABBITMQ_USER}" "${RABBITMQ_PASS}" 2>/dev/null || true
      rabbitmqctl set_permissions -p / "${RABBITMQ_USER}" ".*" ".*" ".*" 2>/dev/null || true
      rabbitmqctl set_user_tags "${RABBITMQ_USER}" administrator 2>/dev/null || true
    fi
    rabbitmqctl stop
    exec rabbitmq-server

[env]
RABBITMQ_USERNAME = rabbitmq
RABBITMQ_PASSWORD = rabbitmq
DOMAIN = bolabaden.org
TS_HOSTNAME = beatapostapita
STACK_NAME = my-media-stack

