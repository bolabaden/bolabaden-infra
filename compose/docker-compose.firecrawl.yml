# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json



secrets:
  openai-api-key:
    file: ${SECRETS_PATH:?}/openai-api-key.txt
  firecrawl-api-key:
    file: ${SECRETS_PATH:?}/firecrawl-api-key.txt


services:
  playwright-service:
    build: https://github.com/firecrawl/firecrawl.git#main:/apps/playwright-service-ts
    image: ghcr.io/firecrawl/playwright-service  # amd64 only unfortunately, maybe we find another image elsewhere for arm64.
    container_name: playwright-service
    hostname: playwright-service
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - backend
    environment:
      PORT: ${FIRECRAWL_PLAYWRIGHT_SERVICE_PORT:-3000}
      PROXY_SERVER: ${FIRECRAWL_PROXY_SERVER:-}
      PROXY_USERNAME: ${FIRECRAWL_PROXY_USERNAME:-}
      PROXY_PASSWORD: ${FIRECRAWL_PROXY_PASSWORD:-}
      BLOCK_MEDIA: ${FIRECRAWL_BLOCK_MEDIA:-false}
    labels:
      kuma.playwright-service.http.name: playwright-service.${TS_HOSTNAME}.${DOMAIN}
      kuma.playwright-service.http.url: https://playwright-service.${DOMAIN}
      kuma.playwright-service.http.interval: 60
    healthcheck:
      test: [
        "CMD-SHELL",
        "apt update && apt install curl -y && apt autoremove -y && curl -f http://127.0.0.1:3000/health >/dev/null 2>&1 || exit 1"
      ]
      interval: 2s
      timeout: 10s
      retries: 10
    restart: always
  firecrawl:
    depends_on:
      redis:
        condition: service_healthy
      playwright-service:
        condition: service_started
      nuq-postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    build: https://github.com/firecrawl/firecrawl.git#main:/apps/api
    image: ghcr.io/firecrawl/firecrawl
    pull_policy: build
    container_name: firecrawl
    hostname: api
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - backend
      - publicnet
    expose:
      - ${FIRECRAWL_INTERNAL_PORT:-3002}
      - ${FIRECRAWL_EXTRACT_WORKER_PORT:-3004}
      - ${FIRECRAWL_WORKER_PORT:-3005}
    secrets:
      - openai-api-key
      - firecrawl-api-key
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    environment:
      REDIS_URL: ${FIRECRAWL_REDIS_URL:-redis://${REDIS_HOSTNAME:-redis}:${REDIS_PORT:-6379}}
      REDIS_RATE_LIMIT_URL: ${FIRECRAWL_REDIS_RATE_LIMIT_URL:-redis://${REDIS_HOSTNAME:-redis}:${REDIS_PORT:-6379}}
      PLAYWRIGHT_MICROSERVICE_URL: ${PLAYWRIGHT_HOST:-http://playwright-service:3000/scrape}
      NUQ_DATABASE_URL: ${FIRECRAWL_NUQ_DATABASE_URL:-postgres://${FIRECRAWL_POSTGRES_USERNAME:-postgres}:${FIRECRAWL_POSTGRES_PASSWORD:-postgres}@${FIRECRAWL_POSTGRES_HOSTNAME:-nuq-postgres}:${FIRECRAWL_POSTGRES_PORT:-5432}/${FIRECRAWL_POSTGRES_DB:-postgres}}
      NUQ_RABBITMQ_URL: ${FIRECRAWL_NUQ_RABBITMQ_URL:-amqp://${RABBITMQ_USERNAME:-rabbitmq}:${RABBITMQ_PASSWORD:-rabbitmq}@${RABBITMQ_HOSTNAME:-rabbitmq}:${RABBITMQ_PORT:-5672}}
      EXTRACT_WORKER_PORT: ${FIRECRAWL_EXTRACT_WORKER_PORT:-3004}
      # To turn on DB authentication, you need to set up Supabase.
      USE_DB_AUTHENTICATION: ${FIRECRAWL_USE_DB_AUTHENTICATION:-}  # supabase is required
      # Provide your OpenAI API key here to enable AI features
      OPENAI_API_KEY_FILE: /run/secrets/openai-api-key
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-}  # e.g. http://localhost:11434/api
      MODEL_NAME: ${FIRECRAWL_MODEL_NAME:-}  # e.g. deepseek-r1:7b
      MODEL_EMBEDDING_NAME: ${FIRECRAWL_MODEL_EMBEDDING_NAME:-}  # e.g. nomic-embed-text
      # Experimental: Use Ollama
      OLLAMA_BASE_URL: ${FIRECRAWL_OLLAMA_BASE_URL:-}  # e.g. https://example.com/v1
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
      # This key lets you access the queue admin panel. Change this if your deployment is publicly accessible.
      BULL_AUTH_KEY_FILE: /run/secrets/firecrawl-api-key
      # Use if you've set up authentication and want to test with a real API key
      TEST_API_KEY_FILE: /run/secrets/firecrawl-api-key
      POSTHOG_API_KEY: ${POSTHOG_API_KEY:-}
      POSTHOG_HOST: ${POSTHOG_HOST:-}
      # Supabase Setup (used to support DB authentication, advanced logging, etc.)
      SUPABASE_ANON_TOKEN: ${SUPABASE_ANON_TOKEN:-}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_TOKEN: ${SUPABASE_SERVICE_TOKEN:-}
      SELF_HOSTED_WEBHOOK_URL: ${FIRECRAWL_SELF_HOSTED_WEBHOOK_URL:-}
      SERPER_API_KEY: ${SERPER_API_KEY:-}
      SEARCHAPI_API_KEY: ${SEARCHAPI_API_KEY:-}
      # You can specify a SearXNG server with the JSON format enabled, if you'd like to use that instead of direct Google.
      # You can also customize the engines and categories parameters, but the defaults should also work just fine.
      # SEARXNG_ENDPOINT: http://your.searxng.server
      SEARXNG_ENDPOINT: ${SEARXNG_ENDPOINT:-https://searxng.$DOMAIN}
      #SEARXNG_ENGINES: ${FIRECRAWL_SEARXNG_ENGINES:-}
      #SEARXNG_CATEGORIES: ${FIRECRAWL_SEARXNG_CATEGORIES:-}
      HOST: ${FIRECRAWL_HOST:-0.0.0.0}
      PORT: ${FIRECRAWL_INTERNAL_PORT:-3002}
      WORKER_PORT: ${FIRECRAWL_WORKER_PORT:-3005}
      ENV: ${FIRECRAWL_ENV:-local}
    labels:
      traefik.enable: true
      homepage.group: AI
      homepage.name: Firecrawl
      homepage.icon: firecrawl.png
      homepage.href: https://firecrawl.${DOMAIN}
      homepage.description: Firecrawl is a tool for crawling and indexing web pages.
      traefik.http.routers.firecrawl.rule: Host(`firecrawl-api.$DOMAIN`) || Host(`firecrawl-api.$TS_HOSTNAME.$DOMAIN`)
      traefik.http.services.firecrawl.loadbalancer.server.port: ${FIRECRAWL_INTERNAL_PORT:-3002}
      deunhealth.restart.on.unhealthy: true
      kuma.firecrawl.http.name: firecrawl.${TS_HOSTNAME}.${DOMAIN}
      kuma.firecrawl.http.url: https://firecrawl.${DOMAIN}
      kuma.firecrawl.http.interval: 60
    command: node dist/src/harness.js --start-docker
    mem_reservation: 4G
    cpus: 4.0
    healthcheck:
      test: [
        "CMD-SHELL",
        "node -e \"require('http').get('http://127.0.0.1:$${FIRECRAWL_INTERNAL_PORT:-3002}/v0/health/liveness', (r) => { let d=''; r.on('data',c=>d+=c); r.on('end',()=>process.exit(r.statusCode===200?0:1)); }).on('error',()=>process.exit(1));\" >/dev/null 2>&1 || exit 1"
      ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: always
  
  nuq-postgres:
    build: https://github.com/firecrawl/firecrawl.git#main:/apps/nuq-postgres
    container_name: nuq-postgres
    hostname: ${NUQ_POSTGRES_HOSTNAME:-nuq-postgres}
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - backend
    volumes:
      - ${CONFIG_PATH:-./volumes}/nuq-postgres/data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${FIRECRAWL_POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${FIRECRAWL_POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${FIRECRAWL_POSTGRES_DB:-postgres}
    labels:
      deunhealth.restart.on.unhealthy: true
      kuma.nuq-postgres.http.name: nuq-postgres.${TS_HOSTNAME}.${DOMAIN}
      kuma.nuq-postgres.http.url: https://nuq-postgres.${DOMAIN}
      kuma.nuq-postgres.http.interval: 60
    healthcheck:
      test: [
        "CMD-SHELL",
        "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB >/dev/null 2>&1 || exit 1"
      ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
  rabbitmq:
    image: docker.io/rabbitmq:3-management
    container_name: rabbitmq
    hostname: rabbitmq
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - backend
    volumes:
      - ./rabbitmq-init.sh:/rabbitmq-init.sh:ro
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME:-rabbitmq}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-rabbitmq}
    command: ["/bin/bash", "/rabbitmq-init.sh"]
    labels:
      deunhealth.restart.on.unhealthy: true
      kuma.rabbitmq.http.name: rabbitmq.${TS_HOSTNAME}.${DOMAIN}
      kuma.rabbitmq.http.url: https://rabbitmq.${DOMAIN}
      kuma.rabbitmq.http.interval: 60
    healthcheck:
      test: [
        "CMD-SHELL",
        "rabbitmq-diagnostics -q check_running >/dev/null 2>&1 || exit 1"
      ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: always