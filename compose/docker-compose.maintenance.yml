# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json
#
# Docker Compose Override for Maintenance and Resource Limits
# This file adds logging configurations and resource limits to prevent disk bloat
# Include it in your compose stack: docker compose -f docker-compose.yml -f compose/docker-compose.maintenance.yml up

# Default logging configuration for all services
x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"
    compress: "true"

services:
  # ==========================
  # METRICS SERVICES
  # ==========================
  
  prometheus:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    # Retention and limits are set via command args in main compose file
    # Ensure PROMETHEUS_RETENTION_TIME and PROMETHEUS_RETENTION_SIZE are set in .env

  victoriametrics:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    # Retention is set via command args in main compose file
    # Ensure VICTORIAMETRICS_RETENTION_PERIOD is set in .env

  grafana:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  loki:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  promtail:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  node-exporter:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  cadvisor:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  blackbox-exporter:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # ==========================
  # STREMIO SERVICES
  # ==========================

  stremthru:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    # Add cleanup command if supported
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================
  # LLM SERVICES
  # ==========================

  open-webui:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    # Cache limits should be set via environment in main compose

  # ==========================
  # MEDIA SERVICES
  # ==========================

  plex:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    environment:
      # Enable transcoder temp cleanup
      - PLEX_PREFERENCE_TranscoderTempDirectory=/tmp
      - PLEX_PREFERENCE_EnableTranscoderTempCleanup=1

  # ==========================
  # INFRASTRUCTURE SERVICES
  # ==========================

  traefik:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  redis:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    # Redis has built-in memory limits via maxmemory config

  # ==========================
  # CODE SERVICES
  # ==========================

  code-server:
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

