[DEFAULT]
nodes = micklethefickle beatapostapita cloudserver1 cloudserver2 cloudserver3
orchestrate = ha
topology = failover
id = 4d284370-1234-5678-9abc-def012345678

[container#1]
type = docker
image = docker.io/traefik:latest
name = traefik
hostname = traefik
run_args = --network {env.STACK_NAME}_default -v /var/run/docker.sock:/var/run/docker.sock:ro -v {env.CONFIG_PATH}/traefik/dynamic:/traefik/dynamic -v {env.CONFIG_PATH}/traefik/certs:/certs -v {env.CONFIG_PATH}/traefik/plugins-local:/plugins-local -v {env.CONFIG_PATH}/traefik/logs:/var/log/traefik:rw -p 80:80 -p 443:443 -p 443:443/udp -e DOCKER_HOST="unix:///var/run/docker.sock" -e DOCKER_API_VERSION="1.52" -e LETS_ENCRYPT_EMAIL="{env.ACME_RESOLVER_EMAIL}" -e CLOUDFLARE_EMAIL="{env.CLOUDFLARE_EMAIL}" -e CLOUDFLARE_API_KEY_FILE="/run/secrets/cloudflare-api-key" -e CLOUDFLARE_ZONE_ID="{env.CLOUDFLARE_ZONE_ID}" --add-host "host.docker.internal:host-gateway" -l "traefik.enable=true" -l "traefik.http.routers.traefik.service=api@internal" -l "traefik.http.routers.traefik.rule=Host(`traefik.{env.DOMAIN}`) || Host(`traefik.{env.TS_HOSTNAME}.{env.DOMAIN}`)" -l "traefik.http.services.traefik.loadbalancer.server.port=8080" -l "homepage.group=Infrastructure" -l "homepage.name=Traefik" -l "homepage.icon=traefik.png" -l "homepage.href=https://traefik.{env.DOMAIN}/dashboard" -l "homepage.widget.type=traefik" -l "homepage.widget.url=http://traefik:8080" -l "homepage.description=Reverse proxy entrypoint for all services with TLS, Cloudflare integration, and auth middleware" -l "kuma.traefik.http.name=traefik.{env.TS_HOSTNAME}.{env.DOMAIN}" -l "kuma.traefik.http.url=https://traefik.{env.DOMAIN}/dashboard" -l "kuma.traefik.http.interval=20" --cap-add NET_ADMIN --restart always
command = --accessLog=true --accessLog.bufferingSize=0 --accessLog.fields.headers.defaultMode=drop --accessLog.fields.headers.names.User-Agent=keep --accessLog.fields.names.StartUTC=drop --accessLog.filePath=/var/log/traefik/traefik.log --accessLog.filters.statusCodes=100-999 --accessLog.format=json --metrics.prometheus.buckets=0.1,0.3,1.2,5.0 --api.dashboard=true --api.debug=true --api.disableDashboardAd=true --api.insecure=true --api=true --certificatesResolvers.letsencrypt.acme.caServer={env.TRAEFIK_CA_SERVER} --certificatesResolvers.letsencrypt.acme.dnsChallenge={env.TRAEFIK_DNS_CHALLENGE} --certificatesResolvers.letsencrypt.acme.dnsChallenge.provider=cloudflare --certificatesResolvers.letsencrypt.acme.dnsChallenge.resolvers={env.TRAEFIK_DNS_RESOLVERS} --certificatesResolvers.letsencrypt.acme.email={env.ACME_RESOLVER_EMAIL} --certificatesResolvers.letsencrypt.acme.httpChallenge={env.TRAEFIK_HTTP_CHALLENGE} --certificatesResolvers.letsencrypt.acme.httpChallenge.entryPoint=web --certificatesResolvers.letsencrypt.acme.tlsChallenge={env.TRAEFIK_TLS_CHALLENGE} --certificatesResolvers.letsencrypt.acme.storage=/certs/acme.json --entryPoints.web.address=:80 --entryPoints.web.http.redirections.entryPoint.scheme=https --entryPoints.web.http.redirections.entryPoint.to=websecure --entryPoints.web.forwardedHeaders.trustedIPs=103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,104.16.0.0/13,104.24.0.0/14,108.162.192.0/18,131.0.72.0/22,141.101.64.0/18,162.158.0.0/15,172.64.0.0/13,173.245.48.0/20,188.114.96.0/20,190.93.240.0/20,197.234.240.0/22,198.41.128.0/17,2400:cb00::/32,2405:8100::/32,2405:b500::/32,2606:4700::/32,2803:f800::/32,2a06:98c0::/29,2c0f:f248::/32 --entryPoints.websecure.forwardedHeaders.trustedIPs=103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,104.16.0.0/13,104.24.0.0/14,108.162.192.0/18,131.0.72.0/22,141.101.64.0/18,162.158.0.0/15,172.64.0.0/13,173.245.48.0/20,188.114.96.0/20,190.93.240.0/20,197.234.240.0/22,198.41.128.0/17,2400:cb00::/32,2405:8100::/32,2405:b500::/32,2606:4700::/32,2803:f800::/32,2a06:98c0::/29,2c0f:f248::/32 --entryPoints.websecure.address=:443 --entryPoints.websecure.http.encodeQuerySemiColons=true --entryPoints.websecure.http.middlewares=bolabaden-error-pages@file,crowdsec@file,strip-www@file --entryPoints.websecure.http.tls=true --entryPoints.websecure.http.tls.certResolver=letsencrypt --entryPoints.websecure.http.tls.domains[0].main={env.DOMAIN} --entryPoints.websecure.http.tls.domains[0].sans=www.{env.DOMAIN},*.{env.DOMAIN},*.{env.TS_HOSTNAME}.{env.DOMAIN} --entryPoints.websecure.http2.maxConcurrentStreams=100 --entryPoints.websecure.http3 --global.checkNewVersion=true --global.sendAnonymousUsage=false --log.level=INFO --ping=true --providers.docker=true --providers.docker.endpoint={env.TRAEFIK_DOCKER_HOST} --providers.docker.network={env.STACK_NAME}_publicnet --providers.docker.defaultRule="Host(`{{ normalize .ContainerName }}.{env.DOMAIN}`) || Host(`{{ normalize .Name }}.{env.DOMAIN}`) || Host(`{{ normalize .ContainerName }}.{env.TS_HOSTNAME}.{env.DOMAIN}`) || Host(`{{ normalize .Name }}.{env.TS_HOSTNAME}.{env.DOMAIN}`)" --providers.docker.exposedByDefault=false --providers.file.directory=/traefik/dynamic/ --providers.file.watch=true --experimental.plugins.bouncer.modulename=github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin --experimental.plugins.bouncer.version=v1.4.6 --experimental.plugins.traefikerrorreplace.modulename=github.com/PseudoResonance/traefikerrorreplace --experimental.plugins.traefikerrorreplace.version=v1.0.1 --serversTransport.insecureSkipVerify=true

[env]
CONFIG_PATH = /home/ubuntu/my-media-stack/volumes
DOMAIN = bolabaden.org
TS_HOSTNAME = beatapostapita
ACME_RESOLVER_EMAIL = admin@bolabaden.org
CLOUDFLARE_EMAIL = admin@bolabaden.org
CLOUDFLARE_ZONE_ID = dummy_zone_id
TRAEFIK_CA_SERVER = https://acme-v02.api.letsencrypt.org/directory
TRAEFIK_DNS_CHALLENGE = true
TRAEFIK_DNS_RESOLVERS = 1.1.1.1,1.0.0.1
TRAEFIK_HTTP_CHALLENGE = false
TRAEFIK_TLS_CHALLENGE = false
TRAEFIK_DOCKER_HOST = unix:///var/run/docker.sock
STACK_NAME = my-media-stack

