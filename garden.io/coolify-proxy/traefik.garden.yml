kind: Deploy
apiVersion: garden.io/v0
name: traefik
description: Traefik reverse proxy
type: container
dependencies:
  - deploy.crowdsec
  - deploy.dockerproxy-ro

spec:
  replicas: 3
  image: docker.io/traefik:latest
  capAdd: [NET_ADMIN]
  extraHosts:
    - host.docker.internal:host-gateway
  env:
    DOCKER_HOST: ${var.TRAEFIK_DOCKER_HOST || "unix:///var/run/docker.sock"}
    DOCKER_API_VERSION: ${var.DOCKER_API_VERSION_OVERRIDE || "1.52"}
    LETS_ENCRYPT_EMAIL: ${var.ACME_RESOLVER_EMAIL}
    CLOUDFLARE_EMAIL: ${var.CLOUDFLARE_EMAIL}
    CLOUDFLARE_API_KEY_FILE: /run/secrets/cloudflare-api-key
    CLOUDFLARE_ZONE_ID: ${var.CLOUDFLARE_ZONE_ID}
  ports:
    - name: dashboard
      containerPort: 8080
    - name: http
      containerPort: 80
      hostPort: 80
    - name: https
      containerPort: 443
      hostPort: 443
    - name: https-udp
      containerPort: 443
      protocol: UDP
      hostPort: 443
  volumes:
    - name: docker-sock
      containerPath: /var/run/docker.sock
      sourcePath: ${var.docker-socket}
      readOnly: true
    - name: dynamic
      containerPath: /traefik/dynamic
      sourcePath: ${var.config-path}/traefik/traefik/dynamic
    - name: certs
      containerPath: /certs
      sourcePath: ${var.config-path}/traefik/certs
    - name: plugins
      containerPath: /plugins-local
      sourcePath: ${var.config-path}/traefik/plugins-local
    - name: logs
      containerPath: /var/log/traefik
      sourcePath: ${var.config-path}/traefik/logs
    - name: traefik-dynamic-core
      containerPath: /traefik/dynamic/core.yaml
      sourcePath: ${var.config-path}/traefik/traefik/dynamic/core.yaml
      readOnly: true
    - name: cloudflare-api-key
      containerPath: /run/secrets/cloudflare-api-key
      sourcePath: ${var.config-path}/secrets/cf-api-key.txt
      readOnly: true
  command:
    - '--accessLog=true'
    - '--accessLog.bufferingSize=0'
    - '--accessLog.fields.headers.defaultMode=drop'
    - '--accessLog.fields.headers.names.User-Agent=keep'
    - '--accessLog.fields.names.StartUTC=drop'
    - '--accessLog.filePath=/var/log/traefik/traefik.log'
    - '--accessLog.filters.statusCodes=100-999'
    - '--accessLog.format=json'
    - '--metrics.prometheus.buckets=0.1,0.3,1.2,5.0'
    - '--api.dashboard=true'
    - '--api.debug=true'
    - '--api.disableDashboardAd=true'
    - '--api.insecure=true'
    - '--api=true'
    - '--certificatesResolvers.letsencrypt.acme.caServer=${var.TRAEFIK_CA_SERVER || "https://acme-v02.api.letsencrypt.org/directory"}'
    - '--certificatesResolvers.letsencrypt.acme.dnsChallenge=${var.TRAEFIK_DNS_CHALLENGE || "true"}'
    - '--certificatesResolvers.letsencrypt.acme.dnsChallenge.provider=cloudflare'
    - '--certificatesResolvers.letsencrypt.acme.dnsChallenge.resolvers=${var.TRAEFIK_DNS_RESOLVERS || "1.1.1.1,1.0.0.1"}'
    - '--certificatesResolvers.letsencrypt.acme.email=${var.ACME_RESOLVER_EMAIL}'
    - '--certificatesResolvers.letsencrypt.acme.httpChallenge=${var.TRAEFIK_HTTP_CHALLENGE || "false"}'
    - '--certificatesResolvers.letsencrypt.acme.httpChallenge.entryPoint=web'
    - '--certificatesResolvers.letsencrypt.acme.tlsChallenge=${var.TRAEFIK_TLS_CHALLENGE || "false"}'
    - '--certificatesResolvers.letsencrypt.acme.storage=/certs/acme.json'
    - '--entryPoints.web.address=:80'
    - '--entryPoints.web.http.redirections.entryPoint.scheme=https'
    - '--entryPoints.web.http.redirections.entryPoint.to=websecure'
    - '--entryPoints.web.forwardedHeaders.trustedIPs=103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,104.16.0.0/13,104.24.0.0/14,108.162.192.0/18,131.0.72.0/22,141.101.64.0/18,162.158.0.0/15,172.64.0.0/13,173.245.48.0/20,188.114.96.0/20,190.93.240.0/20,197.234.240.0/22,198.41.128.0/17,2400:cb00::/32,2405:8100::/32,2405:b500::/32,2606:4700::/32,2803:f800::/32,2a06:98c0::/29,2c0f:f248::/32'
    - '--entryPoints.websecure.forwardedHeaders.trustedIPs=103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,104.16.0.0/13,104.24.0.0/14,108.162.192.0/18,131.0.72.0/22,141.101.64.0/18,162.158.0.0/15,172.64.0.0/13,173.245.48.0/20,188.114.96.0/20,190.93.240.0/20,197.234.240.0/22,198.41.128.0/17,2400:cb00::/32,2405:8100::/32,2405:b500::/32,2606:4700::/32,2803:f800::/32,2a06:98c0::/29,2c0f:f248::/32'
    - '--entryPoints.websecure.address=:443'
    - '--entryPoints.websecure.http.encodeQuerySemiColons=true'
    - '--entryPoints.websecure.http.middlewares=bolabaden-error-pages@file,crowdsec@file,strip-www@file'
    - '--entryPoints.websecure.http.tls=true'
    - '--entryPoints.websecure.http.tls.certResolver=letsencrypt'
    - '--entryPoints.websecure.http.tls.domains[0].main=${var.domain}'
    - '--entryPoints.websecure.http.tls.domains[0].sans=www.${var.domain},*.${var.domain},*.${var.ts-hostname}.${var.domain}'
    - '--entryPoints.websecure.http2.maxConcurrentStreams=100'
    - '--entryPoints.websecure.http3'
    - '--global.checkNewVersion=true'
    - '--global.sendAnonymousUsage=false'
    - '--log.level=INFO'
    - '--ping=true'
    - '--providers.docker=true'
    - '--providers.docker.endpoint=${var.TRAEFIK_DOCKER_HOST || "unix:///var/run/docker.sock"}'
    - '--providers.docker.network=${var.stack-name || "my-media-stack"}_publicnet'
    - '--providers.docker.defaultRule=Host(`{{ normalize .ContainerName }}.${var.domain}`) || Host(`{{ normalize .Name }}.${var.domain}`) || Host(`{{ normalize .ContainerName }}.${var.ts-hostname}.${var.domain}`) || Host(`{{ normalize .Name }}.${var.ts-hostname}.${var.domain}`)'
    - '--providers.docker.exposedByDefault=false'
    - '--providers.file.directory=/traefik/dynamic/'
    - '--providers.file.watch=true'
    - '--experimental.plugins.bouncer.modulename=github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin'
    - '--experimental.plugins.bouncer.version=v1.4.6'
    - '--experimental.plugins.traefikerrorreplace.modulename=github.com/PseudoResonance/traefikerrorreplace'
    - '--experimental.plugins.traefikerrorreplace.version=v1.0.1'
    - '--serversTransport.insecureSkipVerify=true'
  ingresses:
    - path: /
      port: dashboard
      hostname: traefik.${var.domain}
    - path: /
      port: dashboard
      hostname: traefik.${var.ts-hostname}.${var.domain}
  annotations:
    traefik.enable: "true"
    traefik.http.routers.traefik.service: api@internal
    traefik.http.routers.traefik.rule: Host(`traefik.${var.domain}`) || Host(`traefik.${var.ts-hostname}.${var.domain}`)
    traefik.http.services.traefik.loadbalancer.server.port: "8080"
    homepage.group: Infrastructure
    homepage.name: Traefik
    homepage.icon: traefik.png
    homepage.href: https://traefik.${var.domain}/dashboard
    homepage.widget.type: traefik
    homepage.widget.url: http://traefik:8080
    homepage.description: Reverse proxy entrypoint for all services with TLS, Cloudflare integration, and auth middleware
    kuma.traefik.http.name: traefik.${var.ts-hostname}.${var.domain}
    kuma.traefik.http.url: https://traefik.${var.domain}/dashboard
    kuma.traefik.http.interval: "20"
  healthCheck:
    exec:
      command: [traefik, healthcheck, --ping]
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 3
    failureThreshold: 3
  restartPolicy: always
