# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json



services:
  aiostreams:
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    environment:
      - NODE_OPTIONS=--dns-result-order=ipv4first
    networks:
      publicnet: {}

  warp-nat-gateway:
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    environment:
      WARP_LICENSE_KEY_FILE: ""

  warp_router:
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  ip-checker-warp:
    healthcheck:
      test: ["CMD-SHELL", "exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  promtail:
    networks:
      default: {}
    configs:
      - source: promtail.yaml-override
        target: /etc/promtail/config.yaml
        mode: "0777"

  gptr:
    command: [
      "/bin/sh",
      "-c",
      "export OPENAI_API_KEY=$$(cat /run/secrets/openai-api-key 2>/dev/null || echo \"\") && exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf"
    ]

  dockerproxy-ro:
    environment:
      NETWORKS: 1
configs:
  promtail.yaml-override:
    content: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      positions:
        filename: /tmp/positions.yaml

      clients:
        - url: http://loki:3100/loki/api/v1/push

      scrape_configs:
        # Scrape Docker container logs via TCP proxy
        - job_name: docker
          docker_sd_configs:
            - host: tcp://dockerproxy-ro:2375
          relabel_configs:
            - source_labels: ["__meta_docker_container_name"]
              target_label: "container"
              regex: "/(.*)"
              replacement: "$1"

        # Scrape host syslog and other files
        - job_name: system-logs
          static_configs:
            - targets:
                - localhost
              labels:
                job: varlogs
                __path__: /var/log/*.log

        # Scrape custom mounted logs
        - job_name: extra-logs
          static_configs:
            - targets:
                - localhost
              labels:
                job: extralogs
                __path__: /mnt/extra-logs/*.log
