

x-portainer-labels: &portainer-labels
  traefik.enable: "true"
  traefik.http.services.portainer.loadbalancer.server.port: ${PORTAINER_PORT:-9443}

services:
  portainer:
    image: portainer/portainer-ce:lts
    container_name: portainer
    hostname: portainer
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: -H tcp://tasks.agent:${PORTAINER_PORT4:-9001} --tlsskipverify
    ports:
      - ${PORTAINER_PORT:-9443}:9443
      - ${PORTAINER_PORT2:-9000}:9000
      - ${PORTAINER_PORT3:-8000}:8000
    networks:
      - agent_network
      - traefik_public
    volumes:
      - ${ROOT_DIR:-.}/configs/portainer/data:/data
    environment:
      TZ: ${TZ:-America/Chicago}
    labels:
      homepage.group: System Monitoring
      homepage.name: Portainer
      homepage.icon: portainer.png
      homepage.href: https://portainer.$DOMAIN/
      homepage.description: Portainer is a tool that allows you to manage your Docker containers and images.
      <<: *portainer-labels
    deploy:
      labels:
        <<: *portainer-labels
      mode: replicated
      replicas: 1
      placement:
        constraints: [node.role == manager]

  portainer-agent:
    image: portainer/agent:lts
    container_name: portainer-agent
    hostname: portainer
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - agent_network
    volumes:
      - ${SOCK_PATH:-/var/run/docker.sock}:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
    environment:
      TZ: ${TZ:-America/Chicago}
    deploy:
      mode: global
      placement:
        constraints: [node.platform.os == linux]

networks:
  agent_network:
    attachable: true
    driver: overlay
    external: false
