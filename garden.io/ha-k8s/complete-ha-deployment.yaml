# Complete High Availability Deployment
# This manifest ensures all components have HA configuration

---
# Pod Disruption Budget for all services
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: ha-pdb-global
spec:
  minAvailable: 2  # Always maintain at least 2 pods
  selector:
    matchLabels:
      ha: "true"
---
# Horizontal Pod Autoscaler template
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: ha-hpa-template
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ${SERVICE_NAME}-ha
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
---
# NetworkPolicy for HA services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ha-network-policy
spec:
  podSelector:
    matchLabels:
      ha: "true"
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              ha: "true"
  egress:
    - to:
        - podSelector:
            matchLabels:
              ha: "true"
