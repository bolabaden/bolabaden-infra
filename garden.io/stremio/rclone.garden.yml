kind: Deploy
apiVersion: garden.io/v2
name: rclone
description: Rclone cloud storage mount service
type: container

spec:
  image: docker.io/rclone/rclone:1.71
  extraHosts:
    - host.docker.internal:host-gateway
  capAdd:
    - SYS_ADMIN
  securityOpt:
    - apparmor:unconfined
  env:
    TZ: ${var.tz}
  ports:
    - name: http
      containerPort: ${var.RCLONE_PORT || "5572"}
  volumes:
    - name: hostfs
      containerPath: /hostfs
      sourcePath: /
      readOnly: true
    - name: etc-group
      containerPath: /etc/group
      sourcePath: /etc/group
      readOnly: true
    - name: etc-passwd
      containerPath: /etc/passwd
      sourcePath: /etc/passwd
      readOnly: true
    - name: remote-mounts
      containerPath: /mnt/remote
      sourcePath: /mnt/remote
    - name: cache
      containerPath: /.cache
      sourcePath: ${var.config-path}/rclone/.cache
    - name: config
      containerPath: /config/rclone
      sourcePath: ${var.config-path}/rclone/config/rclone
    - name: rclonefm-js
      containerPath: /var/lib/rclonefm/js
      sourcePath: ${var.config-path}/rclonefm/js
    - name: rclone-conf
      containerPath: /config/rclone/rclone.conf
      sourcePath: ${var.config-path}/rclone/rclone.conf
      readOnly: true
    - name: fuse-conf
      containerPath: /etc/fuse.conf
      sourcePath: /etc/fuse.conf
      readOnly: true
  devices:
    - name: fuse
      hostPath: /dev/fuse
      containerPath: /dev/fuse
  command:
    - rcd
    - --rc-web-gui
    - --rc-web-gui-no-open-browser
    - --rc-addr=:${var.RCLONE_PORT || "5572"}
    - --log-level=INFO
    - --rc-no-auth
    - --config=/config/rclone/rclone.conf
    - --cache-dir=/.cache/rclone
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      memory: 60Mi
  ingresses:
    - path: /
      port: http
      hostname: rclone.${var.domain}
    - path: /
      port: http
      hostname: rclone.${var.ts-hostname}.${var.domain}
  healthCheck:
    exec:
      command: [mountpoint, -q, /mnt/remote]
    initialDelaySeconds: 15
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 2
  restartPolicy: always

